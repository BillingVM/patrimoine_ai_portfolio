server {
        listen 80;
        server_name sol.inoutconnect.com www.sol.inoutconnect.com;

        return 301 https://$server_name$request_uri;
}

server
{
    listen 443 ssl;
    listen [::]:443 ssl;

    ssl_certificate /etc/letsencrypt/live/sol.inoutconnect.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sol.inoutconnect.com/privkey.pem;

    root /var/www/sol.inoutconnect.com;

    index index.html index.htm index.php index.cfm;

    server_name sol.inoutconnect.com www.sol.inoutconnect.com;

    access_log   /var/log/nginx/ssl-sol.inoutconnect.com.access.log;
    error_log    /var/log/nginx/ssl-sol.inoutconnect.com.error.log;

    # Portfolio AI API - Reverse proxy to NestJS backend
    location /ai_portfolio/api/ {
        # Proxy to NestJS backend on localhost:3000
        proxy_pass http://localhost:3000/api/;

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Disable cache for API requests
        proxy_cache_bypass $http_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Portfolio AI Frontend (Vue.js)
    location /ai_portfolio/ {
        alias /var/www/sol.inoutconnect.com/ai_portfolio/frontend/dist/;
        try_files $uri $uri/ /ai_portfolio/index.html;

        # Disable cache for development
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ===== Portfolio AI Simple Demo =====

    # API Backend (Node.js Express on port 3001)
    location /portai/api/ {
        proxy_pass http://localhost:3001/api/;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable caching
        proxy_cache_bypass 1;
        proxy_no_cache 1;

        # Timeouts (AI generation can take time)
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # Frontend PHP files
    location ~ ^/portai/.*\.php$ {
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/sol.inoutconnect.com/portai/public$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    }

    # Static assets (CSS, JS)
    location ~ ^/portai/(css|js)/ {
        alias /var/www/sol.inoutconnect.com/portai/public/;
        add_header Cache-Control "no-cache";
    }

    # Frontend (PHP)
    location /portai/ {
        alias /var/www/sol.inoutconnect.com/portai/public/;
        index index.php;

        # Disable caching for development
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Existing root location
    location /
    {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # Existing PHP location
    location ~ \.php$
    {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass   unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME   /var/www/sol.inoutconnect.com$fastcgi_script_name;
        include        fastcgi_params;
    }

    location /.git { deny all; }
}
